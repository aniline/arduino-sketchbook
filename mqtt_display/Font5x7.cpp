#include "Arduino.h"
#include "Font5x7.h"
#include <avr/pgmspace.h>

#define FONT_LEN 480

const byte Font5x7[FONT_LEN] PROGMEM = {
   0x00, 0x01, 0x00, 0x3c, 0x12, 0x12, 0x3d, 0x00, 0x3e, 0x2a, 0x2a, 0x1d,
   0x00, 0x1c, 0x22, 0x22, 0x23, 0x00, 0x3e, 0x22, 0x22, 0x1d, 0x00, 0x3e,
   0x2a, 0x2a, 0x23, 0x00, 0x3e, 0x0a, 0x0a, 0x03, 0x00, 0x1c, 0x22, 0x2a,
   0x3b, 0x00, 0x3e, 0x08, 0x08, 0x3f, 0x00, 0x22, 0x3e, 0x23, 0x00, 0x30,
   0x20, 0x3f, 0x00, 0x3e, 0x08, 0x14, 0x23, 0x00, 0x3e, 0x20, 0x20, 0x21,
   0x00, 0x3e, 0x04, 0x08, 0x04, 0x3f, 0x00, 0x3e, 0x04, 0x08, 0x3f, 0x00,
   0x1c, 0x22, 0x22, 0x1d, 0x00, 0x3e, 0x0a, 0x0a, 0x05, 0x00, 0x1c, 0x22,
   0x32, 0x5d, 0x00, 0x3e, 0x0a, 0x0a, 0x35, 0x00, 0x24, 0x2a, 0x2a, 0x13,
   0x00, 0x02, 0x3e, 0x03, 0x00, 0x1e, 0x20, 0x20, 0x1f, 0x00, 0x1e, 0x20,
   0x18, 0x07, 0x00, 0x1e, 0x20, 0x10, 0x20, 0x1f, 0x00, 0x22, 0x14, 0x08,
   0x14, 0x23, 0x00, 0x02, 0x04, 0x38, 0x04, 0x03, 0x00, 0x32, 0x2a, 0x27,
   0x00, 0x38, 0x24, 0x1c, 0x21, 0x00, 0x3e, 0x24, 0x19, 0x00, 0x18, 0x24,
   0x25, 0x00, 0x18, 0x24, 0x3f, 0x00, 0x3c, 0x34, 0x2d, 0x00, 0x3c, 0x0a,
   0x0b, 0x00, 0x98, 0xa4, 0x7d, 0x00, 0x3e, 0x04, 0x39, 0x00, 0x3b, 0x00,
   0x80, 0x7b, 0x00, 0x3e, 0x08, 0x35, 0x00, 0x3f, 0x00, 0x3c, 0x04, 0x38,
   0x04, 0x39, 0x00, 0x3c, 0x04, 0x39, 0x00, 0x18, 0x24, 0x19, 0x00, 0xfc,
   0x24, 0x19, 0x00, 0x18, 0x24, 0xfd, 0x00, 0x3c, 0x08, 0x05, 0x00, 0x2c,
   0x24, 0x35, 0x00, 0x1e, 0x24, 0x25, 0x00, 0x3c, 0x20, 0x1c, 0x21, 0x00,
   0x1c, 0x20, 0x1d, 0x00, 0x1c, 0x20, 0x1c, 0x20, 0x3d, 0x00, 0x24, 0x18,
   0x25, 0x00, 0x9c, 0xa0, 0x7d, 0x00, 0x34, 0x2c, 0x2d, 0x00, 0x3c, 0x62,
   0x46, 0x3d, 0x00, 0x04, 0x7f, 0x00, 0x44, 0x62, 0x52, 0x4d, 0x00, 0x26,
   0x42, 0x4a, 0x37, 0x00, 0x38, 0x26, 0x70, 0x21, 0x00, 0x2e, 0x4a, 0x4a,
   0x33, 0x00, 0x3c, 0x4a, 0x4a, 0x33, 0x00, 0x02, 0x62, 0x1a, 0x07, 0x00,
   0x34, 0x4a, 0x4a, 0x35, 0x00, 0x24, 0x4a, 0x4a, 0x3d, 0x00, 0x04, 0xa2,
   0x12, 0x0d, 0x00, 0xbf, 0x00, 0x08, 0x08, 0x3e, 0x08, 0x09, 0x00, 0x3c,
   0x42, 0x5a, 0x5d, 0x00, 0x06, 0x00, 0x07, 0x00, 0x07, 0x00, 0x14, 0x3e,
   0x14, 0x3e, 0x15, 0x00, 0x14, 0x08, 0x3e, 0x08, 0x15, 0x00, 0x60, 0x18,
   0x07, 0x00, 0x06, 0x18, 0x61, 0x00, 0x21, 0x00, 0x61, 0x00, 0x08, 0x08,
   0x08, 0x09, 0x00, 0x7c, 0x83, 0x00, 0x82, 0x7d, 0x00, 0xfe, 0x83, 0x00,
   0x82, 0xff, 0x00, 0x10, 0x6c, 0x83, 0x00, 0x82, 0x6c, 0x11, 0x00, 0x28,
   0x28, 0x28, 0x29, 0x00, 0x08, 0x54, 0xfe, 0x54, 0x21, 0x00, 0x80, 0x80,
   0x80, 0x80, 0x81, 0x00, 0xff, 0x00, 0x25, 0x00, 0x65, 0x00, 0x08, 0x04,
   0x02, 0x04, 0x09, 0x00, 0x24, 0x10, 0x08, 0x25, 0x00, 0x34, 0x4a, 0x54,
   0x20, 0x51, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

typedef struct {
     unsigned int offset:12;
     unsigned int len:4;
} t_index;

const t_index Font5x7_idx[128] PROGMEM = {
     {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 },
     {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 },
     {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 },
     {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 }, {   0, 2 },
     {   0, 2 }, { 290, 2 }, { 303, 4 }, { 309, 6 }, { 363, 6 }, { 387, 5 }, { 392, 6 }, { 307, 2 },
     { 338, 3 }, { 341, 3 }, { 315, 6 }, { 292, 6 }, { 331, 2 }, { 333, 5 }, { 329, 2 }, { 321, 4 },
     { 237, 5 }, { 242, 3 }, { 245, 5 }, { 250, 5 }, { 255, 5 }, { 260, 5 }, { 265, 5 }, { 270, 5 },
     { 275, 5 }, { 280, 5 }, { 377, 2 }, { 379, 2 }, {   0, 2 }, { 358, 5 }, {   0, 2 }, { 285, 5 },
     { 298, 5 }, {   2, 5 }, {   7, 5 }, {  12, 5 }, {  17, 5 }, {  22, 5 }, {  27, 5 }, {  32, 5 },
     {  37, 5 }, {  42, 4 }, {  46, 4 }, {  50, 5 }, {  55, 5 }, {  60, 6 }, {  66, 5 }, {  71, 5 },
     {  76, 5 }, {  81, 5 }, {  86, 5 }, {  91, 5 }, {  96, 4 }, { 100, 5 }, { 105, 5 }, { 110, 6 },
     { 116, 6 }, { 122, 6 }, { 128, 4 }, { 344, 3 }, { 325, 4 }, { 347, 3 }, { 381, 6 }, { 369, 6 },
     {   0, 2 }, { 132, 5 }, { 137, 4 }, { 141, 4 }, { 145, 4 }, { 149, 4 }, { 153, 4 }, { 157, 4 },
     { 161, 4 }, { 165, 2 }, { 167, 3 }, { 170, 4 }, { 174, 2 }, { 176, 6 }, { 182, 4 }, { 186, 4 },
     { 190, 4 }, { 194, 4 }, { 198, 4 }, { 202, 4 }, { 206, 4 }, { 210, 5 }, { 215, 4 }, { 219, 6 },
     { 225, 4 }, { 229, 4 }, { 233, 4 }, { 350, 4 }, { 375, 2 }, { 354, 4 }, {   0, 2 }, {   0, 2 },
};

int setup_Font5x7 () {
     return 0;
}

int write_letter(byte *buffer, int buffer_size, char v, int offs) {
  int rc = 0;
  unsigned int v_idx_val = pgm_read_word_near(Font5x7_idx+v);
  t_index v_idx = *((t_index*)&v_idx_val);
  if (offs <= 0) memset(buffer, 0, buffer_size);

  for (int i=0; i<v_idx.len; i++) {
    if ((offs + i)>=buffer_size) {
      return -1;
    }
    buffer[offs + i] = 0xFE & (pgm_read_byte_near(Font5x7+v_idx.offset+i));
  }

  return v_idx.len;
}

int write_string(byte *buffer, int buffer_size, char *str, int blit_offs) {
  int offs = blit_offs;
  int strsiz = strnlen(str, buffer_size);
  int i;
  int cols_used = 0;

  for (i = 0; i<strsiz; i++) {
    int cols = write_letter(buffer, buffer_size, str[i], offs);
    if (cols == -1) {
      return cols_used;
    } else {
      cols_used += cols;
      offs += cols;
    }
  }
  return cols_used;
}
